Bootstrap: docker
From: ubuntu:24.04

%labels
    Author Anatolij Zubow, zubow@tkn.tu-berlin.de
    Version 1.0

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    # Update system packages
    apt-get update && apt-get install -y --no-install-recommends \
        wget \
        curl \
        git \
        build-essential \
        ca-certificates \
        libssl-dev \
        libffi-dev \
        libblas-dev \
        liblapack-dev \
        python3-venv \
        cmake \
        libzmq3-dev \
        libprotobuf-dev \
        protobuf-compiler \
        pkg-config \
        && rm -rf /var/lib/apt/lists/*

    apt-get update
    apt-get install -y software-properties-common wget gnupg
    add-apt-repository universe

    apt-get update
    apt-get install -y libzmq3-dev cppzmq-dev llvm-15 llvm-15-dev libclang-15-dev

    # Install ns3 and ns3sionna under opt which is writeable
    cd /opt
    wget https://www.nsnam.org/releases/ns-allinone-3.40.tar.bz2
    tar xf ns-allinone-3.40.tar.bz2
    cd ns-allinone-3.40

    cd ./ns-3.40/contrib
    git clone https://github.com/tkn-tub/ns3sionna.git ./sionna

    cd ../
    ./ns3 configure --enable-examples
    ./ns3 build

    cd ./contrib/sionna/model/ns3sionna/
    python3 -m venv /opt/sionna-venv

    # Activate venv and install dependencies
    /bin/bash -c "source /opt/sionna-venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt"


%runscript
    # Run bash
    echo "This is Ubuntu 24.04 + Python 3.12 container with ns3sionna framework installed."
    echo "Run the server component, i.e. source /opt/sionna-venv/bin/activate ; cd /opt/ns-allinone-3.40/ns-3.40/contrib/sionna/model/ns3sionna/ ; ./run_python_proto.sh"
    echo "Run some example ns3 script, i.e. cd /opt/ns-allinone-3.40/ns-3.40/ ; ./ns3 run ns3sionna-example-sionna-sensing-mobile"
    exec /bin/bash "$@"
